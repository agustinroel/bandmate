<!-- ═══════════════════════════════════════════════ -->
<!--  ① HERO SECTION                               -->
<!-- ═══════════════════════════════════════════════ -->
<section class="cm-hero">
  <h1 class="cm-hero-title">Build your band. Play together.</h1>
  <p class="cm-hero-sub">Find musicians, create bands, and prepare for live shows.</p>

  <!-- Social Signals Bar -->
  <div class="cm-signals-bar">
    <div class="cm-signal-item" matTooltip="Musicians active in the last 7 days">
      <mat-icon class="cm-signal-icon">bolt</mat-icon>
      <span class="cm-signal-count">{{ activeCount() }}</span> <span>active</span>
    </div>
    <div
      class="cm-signal-item cm-signal-clickable"
      matTooltip="Invitations waiting for response"
      (click)="openInvitations()"
    >
      <mat-icon class="cm-signal-icon">mail</mat-icon>
      <span class="cm-signal-count">{{ pendingInvitesCount() }}</span> <span>pending</span>
    </div>
    <div class="cm-signal-item" matTooltip="Reshearsals happening this week">
      <mat-icon class="cm-signal-icon">event</mat-icon>
      <span class="cm-signal-count">{{ rehearsalsThisWeek() }}</span> <span>weekly</span>
    </div>
  </div>

  <div class="cm-hero-actions">
    <button mat-flat-button color="primary" class="rounded-pill px-4" (click)="scrollToMusicians()">
      <mat-icon class="me-1">explore</mat-icon>
      Explore Musicians
    </button>
  </div>
</section>

<div class="main-content px-3 px-md-5">
  <!-- ═══════════════════════════════════════════════ -->
  <!--  ② MUSICIANS NEAR YOU                         -->
  <!-- ═══════════════════════════════════════════════ -->
  <section class="cm-section" id="cm-musicians-anchor">
    <div class="cm-section-head">
      <div>
        <div class="cm-section-title">Musicians</div>
        @if (!loading()) {
          <div class="cm-section-count">{{ resultCountLabel() }}</div>
        }
      </div>
    </div>

    <!-- Search & Instrument Chips -->
    <div class="cm-filter-bar">
      <mat-form-field appearance="outline" subscriptSizing="dynamic" class="cm-search-field">
        <mat-icon matPrefix class="text-secondary me-2">search</mat-icon>
        <input
          matInput
          [(ngModel)]="query"
          (input)="onSearchInput()"
          placeholder="Search by name or username..."
        />
      </mat-form-field>

      <div class="d-flex gap-2 flex-wrap">
        @for (inst of instrumentOptions; track inst) {
          <button
            mat-stroked-button
            class="cm-instrument-btn"
            [class.active]="selectedInstruments().includes(inst)"
            (click)="toggleInstrument(inst)"
          >
            {{ inst }}
          </button>
        }
      </div>
    </div>

    <!-- Active Filter Chips -->
    @if (activeFilters().length > 0) {
      <div class="cm-active-chips">
        @for (f of activeFilters(); track f.value) {
          <span class="cm-chip" (click)="removeFilter(f)">
            {{ f.label }}
            <mat-icon>close</mat-icon>
          </span>
        }
        <button class="cm-clear-link" (click)="clearFilters()">Clear all</button>
      </div>
    }

    <!-- Loading / States -->
    @if (loading()) {
      <div class="d-flex justify-content-center p-5">
        <mat-spinner diameter="40"></mat-spinner>
      </div>
    } @else if (error()) {
      <div class="cm-empty">
        <mat-icon class="cm-empty-icon text-danger">error_outline</mat-icon>
        <div class="h5 text-danger mb-3">{{ error() }}</div>
        <button mat-flat-button color="primary" (click)="loadProfiles()">Try again</button>
      </div>
    } @else if (profiles().length === 0) {
      <div class="cm-empty">
        <mat-icon class="cm-empty-icon">search_off</mat-icon>
        <div class="h5 text-secondary">No musicians found</div>
        <p class="text-muted small">Try adjusting your filters or search term.</p>
        <button mat-stroked-button class="mt-2" (click)="clearFilters()">Reset Filters</button>
      </div>
    } @else {
      <!-- Grid -->
      <div class="cm-card-grid">
        @for (user of profiles(); track user.id) {
          <div class="cm-musician-card cm-gsap-item">
            <div class="cm-card-banner"></div>

            <div class="cm-card-body">
              <!-- Avatar -->
              <div
                class="cm-avatar-wrap"
                [class.cm-ring-pro]="user.subscription_tier === 'pro'"
                [class.cm-ring-studio]="user.subscription_tier === 'studio'"
              >
                @if (user.avatar_url) {
                  <img [src]="user.avatar_url" alt="" />
                } @else {
                  <div class="cm-avatar-placeholder">
                    <mat-icon>person</mat-icon>
                  </div>
                }
                <!-- Floating Badge -->
                @if (user.subscription_tier === 'pro' || user.subscription_tier === 'studio') {
                  <div
                    class="cm-badge-floating"
                    [class.is-studio]="user.subscription_tier === 'studio'"
                    [matTooltip]="
                      user.subscription_tier === 'studio' ? 'Studio Member' : 'Pro Member'
                    "
                  >
                    <mat-icon>{{
                      user.subscription_tier === 'studio' ? 'auto_awesome' : 'verified'
                    }}</mat-icon>
                  </div>
                }
              </div>

              <!-- Info -->
              <div class="cm-card-name text-truncate">
                {{ user.full_name || user.username }}
                @if (user.subscription_tier === 'pro') {
                  <span class="cm-text-badge tier-pro">PRO</span>
                } @else if (user.subscription_tier === 'studio') {
                  <span class="cm-text-badge tier-studio">STUDIO</span>
                }
              </div>
              <div class="cm-card-username">@{{ user.username }}</div>

              <!-- Status Badge -->
              <div class="cm-card-status" [ngClass]="musicianStatus(user).class">
                {{ musicianStatus(user).label }}
              </div>

              <!-- Bio -->
              @if (user.bio) {
                <p class="cm-card-bio">{{ user.bio }}</p>
              } @else {
                <p class="cm-card-bio" style="opacity: 0.4; font-style: italic">
                  Ready to play and collaborate.
                </p>
              }

              <!-- Instrument Chips -->
              <div class="cm-instrument-chips">
                @for (inst of user.instruments || []; track inst) {
                  <span class="cm-inst-chip">{{ inst }}</span>
                }
                @if (!user.instruments?.length) {
                  <span class="cm-inst-chip" style="opacity: 0.4">No instruments</span>
                }
              </div>

              <!-- Activity -->
              <div class="cm-card-activity">{{ activityLabel(user) }}</div>
            </div>

            <!-- Hover Overlay Actions -->
            <div class="cm-card-overlay">
              <a
                mat-flat-button
                color="primary"
                class="cm-overlay-btn"
                [routerLink]="['/u', user.username]"
              >
                View Profile
              </a>

              @if (isInvited(user.id)) {
                <button
                  mat-flat-button
                  disabled
                  class="cm-overlay-btn"
                  style="background: rgba(255, 255, 255, 0.2) !important; color: white !important"
                >
                  <mat-icon class="me-1">check</mat-icon>
                  Invite Sent
                </button>
              } @else {
                <button
                  mat-stroked-button
                  class="cm-overlay-btn"
                  style="color: white; border-color: rgba(255, 255, 255, 0.3)"
                  (click)="inviteToBand(user.id)"
                >
                  <mat-icon class="me-1" style="font-size: 16px; width: 16px; height: 16px"
                    >group_add</mat-icon
                  >
                  Invite to Band
                  @if (!isPro()) {
                    <mat-icon class="cm-pro-lock" style="color: var(--bm-accent)">lock</mat-icon>
                  }
                </button>
              }

              <button
                mat-stroked-button
                class="cm-overlay-btn"
                style="color: white; border-color: rgba(255, 255, 255, 0.3)"
                (click)="messageMusician(user.id)"
              >
                <mat-icon class="me-1" style="font-size: 16px; width: 16px; height: 16px"
                  >mail</mat-icon
                >
                Message
                @if (!isPro()) {
                  <mat-icon class="cm-pro-lock" style="color: var(--bm-accent)">lock</mat-icon>
                }
              </button>
            </div>
          </div>
        }
      </div>
    }
  </section>

  <!-- ═══════════════════════════════════════════════ -->
  <!--  ③ BANDS                                      -->
  <!-- ═══════════════════════════════════════════════ -->
  <section class="cm-section">
    <div class="cm-section-head">
      <div class="cm-section-title">Bands</div>
    </div>

    @if (bandsLoading()) {
      <div class="d-flex justify-content-center py-5">
        <mat-spinner diameter="32"></mat-spinner>
      </div>
    } @else if (myBands().length > 0) {
      <div class="cm-bands-grid mb-4">
        @for (band of myBands(); track band.id) {
          <div class="cm-band-card cm-gsap-item">
            <a class="cm-band-link" [routerLink]="['/bands', band.id]">
              <div class="cm-band-avatar">
                @if (band.avatar_url) {
                  <img [src]="band.avatar_url" alt="" />
                } @else {
                  <mat-icon>groups</mat-icon>
                }
              </div>
              <div class="flex-grow-1 min-w-0">
                <div class="fw-bold text-truncate">{{ band.name }}</div>
                <div class="small text-muted text-truncate">
                  {{ band.description || 'No description' }}
                </div>

                @if (band.my_roles.includes('owner')) {
                  <div class="cm-role-badge cm-role-owner">Owner</div>
                } @else {
                  <div class="cm-role-badge cm-role-member">Member</div>
                }
              </div>
            </a>

            <!-- Manage Actions -->
            <div class="cm-band-manage">
              <button mat-icon-button [matMenuTriggerFor]="menu" class="opacity-50">
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #menu="matMenu">
                @if (band.my_roles.includes('owner')) {
                  <button mat-menu-item (click)="editBand(band)">
                    <mat-icon>edit</mat-icon>
                    <span>Edit Band</span>
                  </button>
                  <button mat-menu-item (click)="deleteBand(band)" class="text-danger">
                    <mat-icon color="warn">delete</mat-icon>
                    <span>Delete Band</span>
                  </button>
                } @else {
                  <button mat-menu-item (click)="leaveBand(band)">
                    <mat-icon>logout</mat-icon>
                    <span>Leave Band</span>
                  </button>
                }
              </mat-menu>
            </div>
          </div>
        }
      </div>

      <div class="text-center">
        <button mat-stroked-button class="rounded-pill px-4" (click)="createBand()">
          <mat-icon class="me-1">add</mat-icon>
          Create another band
          @if (!isPro()) {
            <mat-icon class="cm-pro-lock">lock</mat-icon>
          }
        </button>
      </div>
    } @else {
      <div class="cm-band-cta">
        <mat-icon class="cm-band-cta-icon">diversity_3</mat-icon>
        <div class="cm-band-cta-title">Create your band</div>
        <div class="cm-band-cta-sub">
          Share setlists, rehearse together, and prepare for live shows.
        </div>
        <button
          mat-flat-button
          color="primary"
          class="cm-hero-cta rounded-pill px-5"
          (click)="createBand()"
        >
          <mat-icon class="me-2">add</mat-icon>
          Create Band
          @if (!isPro()) {
            <mat-icon class="cm-pro-lock">lock</mat-icon>
          }
        </button>
        @if (!isPro()) {
          <div class="cm-band-limit mt-3">
            Free plan: 1 band ·
            <span
              class="text-primary fw-bold"
              (click)="sub.requireTierOrUpgrade('create_band')"
              style="cursor: pointer"
              >Upgrade to create more</span
            >
          </div>
        }
      </div>
    }
  </section>

  <mat-divider class="mb-5"></mat-divider>

  <div class="row g-5">
    <!-- ═══════════════════════════════════════════════ -->
    <!--  ④ UPCOMING SHOWS                             -->
    <!-- ═══════════════════════════════════════════════ -->
    <div class="col-12 col-lg-8">
      <section class="cm-section">
        <div class="cm-section-head">
          <div class="cm-section-title">Upcoming Shows</div>
        </div>

        @if (eventsStore.discoveryEvents().length > 0) {
          <div class="cm-events-scroll">
            @for (ev of eventsStore.discoveryEvents(); track ev.id) {
              <div class="cm-event-card cm-gsap-item" [routerLink]="['/events', ev.id]">
                <div class="d-flex gap-3 align-items-center">
                  <div class="cm-event-avatar">
                    @if ($any(ev).bands?.avatar_url) {
                      <img [src]="$any(ev).bands?.avatar_url" alt="" />
                    } @else {
                      <mat-icon>music_note</mat-icon>
                    }
                  </div>
                  <div class="flex-grow-1 min-w-0">
                    <div class="fw-bold text-truncate">{{ $any(ev).title }}</div>
                    <div class="small text-muted text-truncate mb-1">
                      {{ $any(ev).bands?.name }}
                    </div>
                    <div class="small text-muted d-flex align-items-center gap-1">
                      <mat-icon style="font-size: 12px; width: 12px; height: 12px"
                        >calendar_today</mat-icon
                      >
                      {{ $any(ev).event_date | date: 'MMM d' }}
                      <span>•</span>
                      <mat-icon style="font-size: 12px; width: 12px; height: 12px"
                        >location_on</mat-icon
                      >
                      <span class="text-truncate">{{ $any(ev).location_name }}</span>
                    </div>
                    <div class="cm-social-proof">
                      <mat-icon style="font-size: 12px; width: 12px; height: 12px">people</mat-icon>
                      3 musicians attending
                    </div>
                  </div>
                  <div class="text-end">
                    @if ($any(ev).ticket_price > 0) {
                      <span class="cm-badge-paid">{{ $any(ev).ticket_price | currency }}</span>
                    } @else {
                      <span class="cm-badge-free">FREE</span>
                    }
                  </div>
                </div>
              </div>
            }
          </div>
        } @else {
          <div class="p-4 text-center opacity-50 bg-white rounded-4 border">
            <mat-icon class="mb-2">event_busy</mat-icon>
            <div class="small">No shows scheduled nearby.</div>
          </div>
        }
      </section>
    </div>

    <!-- ═══════════════════════════════════════════════ -->
    <!--  ⑤ RECENT ACTIVITY                            -->
    <!-- ═══════════════════════════════════════════════ -->
    <div class="col-12 col-lg-4">
      <section class="cm-section">
        <div class="cm-section-head">
          <div class="cm-section-title">Recent Activity</div>
        </div>

        <div class="cm-activity-module">
          <div class="cm-activity-list">
            @for (act of activities(); track act.id) {
              <div class="cm-activity-item">
                <div class="cm-activity-icon">
                  <mat-icon>{{ act.icon }}</mat-icon>
                </div>
                <div class="flex-grow-1">
                  <div class="small fw-semibold">{{ act.text }}</div>
                  <div class="cm-activity-time">{{ act.time }}</div>
                </div>
              </div>
            }
          </div>
        </div>
      </section>
    </div>
  </div>
</div>
