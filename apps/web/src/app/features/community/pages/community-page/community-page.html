<!-- Header (Standardized) -->
<header class="bm-page-header">
  <div class="bm-mark" aria-hidden="true">
    <mat-icon>groups</mat-icon>
  </div>

  <div class="flex-grow-1">
    <h2 class="bm-page-title">Community</h2>
    <div class="small opacity-75">Connect with {{ profiles().length }} musicians</div>
  </div>
</header>

<div class="main-content mt-3">
  <!-- Shows Near You Section -->
  <div class="bm-section-head mb-3">
    <div>
      <div class="bm-section-title">Shows Near You</div>
      <div class="bm-section-sub small opacity-75">
        Discover live music in your area: {{ eventsStore.discoveryEvents().length }} events
      </div>
    </div>
    <mat-icon class="opacity-25" style="font-size: 28px; width: 28px; height: 28px"
      >celebration</mat-icon
    >
  </div>

  @if (eventsStore.loading() && eventsStore.discoveryEvents().length === 0) {
    <div class="d-flex gap-3 py-2 overflow-auto pb-3">
      @for (i of [1, 2, 3]; track i) {
        <div
          class="skeleton-card rounded-3 shadow-sm"
          style="min-width: 320px; height: 100px; background: #f0f0f0"
        ></div>
      }
    </div>
  } @else if (eventsStore.discoveryEvents().length > 0) {
    <div class="d-flex gap-3 py-2 overflow-auto pb-3" style="scroll-snap-type: x mandatory">
      @for (ev of eventsStore.discoveryEvents(); track ev.id) {
        <mat-card
          class="p-0 border-0 shadow-sm rounded-3 overflow-hidden"
          style="min-width: 340px; flex-shrink: 0; cursor: pointer; scroll-snap-align: start"
          [routerLink]="['/events', ev.id]"
        >
          <div class="p-3 d-flex gap-3 align-items-center">
            <!-- Band Avatar -->
            <div
              class="rounded-circle d-flex align-items-center justify-content-center flex-shrink-0"
              style="
                width: 56px;
                height: 56px;
                background: var(--bm-gradient-dark);
                border: 1px solid rgba(233, 196, 106, 0.2);
                color: var(--bm-accent);
              "
            >
              @if ($any(ev).bands?.avatar_url) {
                <img
                  [src]="$any(ev).bands?.avatar_url"
                  class="rounded-circle"
                  style="width: 100%; height: 100%; object-fit: cover"
                />
              } @else {
                <mat-icon>music_note</mat-icon>
              }
            </div>

            <!-- Event Info -->
            <div class="flex-grow-1 min-w-0">
              <h6 class="fw-bold mb-1 text-truncate">{{ $any(ev).title }}</h6>
              <div class="small text-muted d-flex align-items-center gap-1 mb-1">
                <mat-icon style="font-size: 14px; width: 14px; height: 14px">groups</mat-icon>
                <span class="text-truncate">{{ $any(ev).bands?.name || 'Unknown Band' }}</span>
              </div>
              <div class="d-flex align-items-center gap-2 small">
                <span class="text-muted">
                  <mat-icon
                    style="font-size: 12px; width: 12px; height: 12px; vertical-align: middle"
                    >calendar_today</mat-icon
                  >
                  {{ $any(ev).event_date | date: 'MMM d, yyyy' }}
                </span>
                <span class="text-muted">â€¢</span>
                <span class="text-muted text-truncate">{{ $any(ev).location_name }}</span>
              </div>
            </div>

            <!-- Price Badge -->
            <div class="text-end flex-shrink-0">
              @if ($any(ev).ticket_price > 0) {
                <span class="badge bg-primary rounded-pill px-3 py-2">
                  {{ $any(ev).ticket_price | currency: $any(ev).currency || 'EUR' }}
                </span>
              } @else {
                <span class="badge bg-success rounded-pill px-3 py-2">FREE</span>
              }
            </div>
          </div>
        </mat-card>
      }
    </div>
  } @else {
    <div class="text-center py-4 opacity-50">
      <mat-icon style="font-size: 48px; width: 48px; height: 48px">event_busy</mat-icon>
      <p class="small mt-2 mb-0">No events nearby. Check back soon!</p>
    </div>
  }

  <mat-divider class="my-4"></mat-divider>

  <!-- Filters Card -->
  <div class="filters-card">
    <div class="d-flex flex-wrap gap-3 align-items-center">
      <!-- Search (Standard Mat Input) -->
      <mat-form-field
        appearance="outline"
        subscriptSizing="dynamic"
        class="flex-grow-1"
        style="min-width: 250px"
      >
        <mat-label>Search Name</mat-label>
        <mat-icon matPrefix class="text-secondary me-2">search</mat-icon>
        <input
          matInput
          [(ngModel)]="query"
          (keydown.enter)="load()"
          placeholder="Name or username..."
        />
      </mat-form-field>

      <!-- Filters -->
      <mat-form-field appearance="outline" subscriptSizing="dynamic" style="min-width: 150px">
        <mat-label>Instruments</mat-label>
        <mat-select [(ngModel)]="instruments" multiple>
          @for (inst of instrumentOptions; track inst) {
            <mat-option [value]="inst">{{ inst }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" subscriptSizing="dynamic" style="min-width: 150px">
        <mat-label>Genres</mat-label>
        <mat-select [(ngModel)]="genres" multiple>
          @for (genre of genreOptions; track genre) {
            <mat-option [value]="genre">{{ genre }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <div class="d-flex align-items-center gap-3 px-2 border-start h-100">
        <mat-checkbox [(ngModel)]="sings" color="primary">Sings</mat-checkbox>
        <mat-checkbox [(ngModel)]="nearbyOnly" color="accent">
          <mat-icon style="font-size: 16px; width: 16px; height: 16px; vertical-align: middle"
            >near_me</mat-icon
          >
          Nearby
        </mat-checkbox>
      </div>

      <div class="d-flex gap-2 ms-auto">
        <button mat-flat-button color="primary" (click)="load()" [disabled]="loading()">
          Search
        </button>
        <button mat-stroked-button (click)="clearFilters()" [disabled]="loading()">Clear</button>
      </div>
    </div>
  </div>

  @if (loading()) {
    <div class="d-flex justify-content-center p-5 mt-5">
      <mat-spinner diameter="50"></mat-spinner>
    </div>
  } @else if (error()) {
    <div class="mt-5 text-center opacity-50">
      <mat-icon class="display-4 text-danger mb-3">error_outline</mat-icon>
      <div class="h5 text-danger">{{ error() }}</div>
      <button mat-stroked-button (click)="load()">Try again</button>
    </div>
  } @else {
    <div class="row g-4 mt-2">
      @for (user of profiles(); track user.id) {
        <div class="col-12 col-md-6 col-lg-4">
          <a
            [routerLink]="['/u', user.username]"
            class="text-decoration-none text-reset h-100 d-block card-hover-wrapper"
          >
            <div class="premium-card">
              <!-- Card Header Gradient -->
              <div class="card-gradient"></div>

              <div class="p-4 pt-0 d-flex flex-column flex-grow-1 text-center">
                <!-- Avatar -->
                <div class="card-avatar-wrapper">
                  @if (user.avatar_url) {
                    <img [src]="user.avatar_url" (error)="user.avatar_url = null" alt="" />
                  } @else {
                    <div class="avatar-placeholder">
                      <mat-icon>person</mat-icon>
                    </div>
                  }
                </div>

                <!-- Info -->
                <div class="mt-3 mb-3">
                  <h3 class="fw-bold mb-0 text-dark">{{ user.full_name || user.username }}</h3>
                  <div class="text-primary small fw-semibold mb-2">@{{ user.username }}</div>

                  @if (user.bio) {
                    <p class="small text-muted line-clamp-2 px-2">{{ user.bio }}</p>
                  } @else {
                    <p class="small text-muted opacity-50 fst-italic">No bio available</p>
                  }
                </div>

                <!-- Chips -->
                <div class="mt-auto d-flex gap-2 flex-wrap justify-content-center">
                  @for (inst of user.instruments || []; track inst) {
                    <span class="bm-chip-sm">{{ inst }}</span>
                  }
                  @if (!user.instruments?.length) {
                    <span class="text-muted small opacity-50">No instruments</span>
                  }
                </div>
              </div>
            </div>
          </a>
        </div>
      }

      @if (profiles().length === 0) {
        <div class="col-12 text-center p-5 opacity-50 mt-4">
          <mat-icon class="display-1 mb-3 text-secondary">search_off</mat-icon>
          <div class="h4 text-secondary">No musicians found</div>
          <p class="text-muted">Try adjusting your filters to see more results.</p>
        </div>
      }
    </div>
  }
</div>
