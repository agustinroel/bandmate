@if (state() === 'loading') {
  <div class="bm-work bm-center">
    <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
  </div>
}

@if (state() === 'error') {
  <div class="bm-work bm-container">
    <div class="bm-alert">
      <div class="bm-alert__text">{{ error() }}</div>
      <button mat-stroked-button (click)="load()">
        <mat-icon class="bm-ic">refresh</mat-icon>
        Retry
      </button>
    </div>
  </div>
}

@if (state() === 'ready') {
  @if (work()) {
    <div class="bm-work">
      <!-- Sticky header -->
      <div class="bm-header">
        <div class="bm-header__left">
          <button mat-stroked-button class="bm-back" routerLink="/songs">
            <mat-icon class="bm-ic">arrow_back</mat-icon>
            Back
          </button>

          <div class="bm-title">
            <div class="bm-h1">{{ work()!.title }}</div>
            <div class="bm-sub">{{ work()!.artist }}</div>
          </div>
        </div>

        <div class="bm-header__right">
          <button mat-flat-button color="primary" (click)="createMyVersion()">
            <mat-icon class="me-1">edit_note</mat-icon>
            Create my version
          </button>
        </div>
      </div>

      <div class="bm-container">
        <!-- Rights / notes -->
        @if (work()!.rightsNotes) {
          <div class="bm-banner">
            <mat-icon class="bm-banner__ic">info</mat-icon>
            <div class="bm-banner__body">
              <div class="bm-banner__title">Copyright notice</div>
              <div class="bm-banner__text">{{ work()!.rightsNotes }}</div>
            </div>
          </div>
        }

        <!-- Content -->
        @if (hasArrangements()) {
          @if (arrangements()[0]; as top) {
            <!-- Top arrangement hero -->
            <mat-card
              class="bm-hero lib-card-gsap"
              tabindex="0"
              role="button"
              (click)="openArrangement(top.id)"
              (keydown.enter)="openArrangement(top.id)"
            >
              <div class="bm-hero__top">
                <div class="bm-hero__kicker">Top arrangement</div>
                <div class="bm-hero__title">
                  Arrangement v{{ top.version ?? 1 }}
                  @if (top.isSeed) {
                    <span class="bm-chip bm-chip--seed">Seed</span>
                  }
                </div>

                <div class="bm-hero__meta">
                  @if (top.key) {
                    <span class="bm-chip bm-chip--key">
                      <span class="bm-chip__k">Key</span>
                      <span class="bm-chip__v">{{ top.key }}</span>
                    </span>
                  }

                  @if (top.bpm) {
                    <span class="bm-chip">
                      <mat-icon class="bm-chip__ic">speed</mat-icon>
                      <span class="bm-chip__v">{{ top.bpm }} BPM</span>
                    </span>
                  }

                  @if (durationLabel(top.durationSec)) {
                    <span class="bm-chip">
                      <mat-icon class="bm-chip__ic">schedule</mat-icon>
                      <span class="bm-chip__v">{{ durationLabel(top.durationSec) }}</span>
                    </span>
                  }

                  <span
                    class="bm-chip bm-chip--rating"
                    [attr.title]="ratingLabel(top.ratingAvg, top.ratingCount)"
                  >
                    <mat-icon class="bm-chip__ic">star</mat-icon>
                    <span class="bm-chip__v">
                      {{ top.ratingAvg ?? 0 | number: '1.1-1' }}
                      <span class="bm-chip__sub">({{ top.ratingCount ?? 0 }})</span>
                    </span>
                  </span>
                </div>

                @if (top.notes) {
                  <div class="bm-hero__note">{{ top.notes }}</div>
                } @else {
                  <div class="bm-hero__note">
                    Seed arrangement: chord progression + structure only. No copyrighted lyrics
                    included.
                  </div>
                }
              </div>

              <div class="bm-hero__cta">
                <span class="bm-hero__hint">Open arrangement</span>
                <mat-icon>arrow_forward</mat-icon>
              </div>
            </mat-card>
          }

          <!-- Your versions -->
          @if (myVersions().length > 0) {
            <div class="bm-section">
              <div class="bm-section__title">Your versions</div>
              <div class="bm-grid">
                @for (song of myVersions(); track song.id) {
                  <mat-card
                    class="bm-card lib-card-gsap"
                    tabindex="0"
                    role="button"
                    (click)="openMyVersion(song.id)"
                    (keydown.enter)="openMyVersion(song.id)"
                  >
                    <div class="bm-card__head">
                      <div class="bm-card__title">
                        <mat-icon class="bm-ic-sm">person</mat-icon>
                        {{ song.title }}
                      </div>
                    </div>

                    <div class="bm-card__meta">
                      @if (song.key) {
                        <span class="bm-chip bm-chip--key">
                          <span class="bm-chip__k">Key</span>
                          <span class="bm-chip__v">{{ song.key }}</span>
                        </span>
                      }
                      <span class="bm-chip">Personal copy</span>
                    </div>

                    <div class="bm-card__foot">
                      Updated: {{ song.updatedAt | date: 'MMM d, y' }}
                    </div>
                  </mat-card>
                }
              </div>
            </div>
          }

          <!-- Other arrangements -->
          <div class="bm-section">
            <div class="bm-section__title">Community Arrangements</div>

            <div class="bm-grid">
              @for (a of arrangements(); track a.id) {
                <mat-card
                  class="bm-card lib-card-gsap"
                  tabindex="0"
                  role="button"
                  (click)="openArrangement(a.id)"
                  (keydown.enter)="openArrangement(a.id)"
                >
                  <div class="bm-card__head">
                    <div class="bm-card__title">
                      @if (a.authorName) {
                        Arrangement by {{ a.authorName }}
                      } @else {
                        Arrangement v{{ a.version ?? 1 }}
                      }

                      @if (a.isSeed) {
                        <span class="bm-chip bm-chip--seed">Seed</span>
                      }
                    </div>

                    <div class="bm-card__right">
                      <span
                        class="bm-chip bm-chip--rating"
                        [attr.title]="ratingLabel(a.ratingAvg, a.ratingCount)"
                      >
                        <mat-icon class="bm-chip__ic">star</mat-icon>
                        <span class="bm-chip__v">
                          {{ a.ratingAvg ?? 0 | number: '1.1-1' }}
                          <span class="bm-chip__sub">({{ a.ratingCount ?? 0 }})</span>
                        </span>
                      </span>
                    </div>
                  </div>

                  <div class="bm-card__meta">
                    @if (a.key) {
                      <span class="bm-chip bm-chip--key">
                        <span class="bm-chip__k">Key</span>
                        <span class="bm-chip__v">{{ a.key }}</span>
                      </span>
                    }

                    @if (a.bpm) {
                      <span class="bm-chip">
                        <mat-icon class="bm-chip__ic">speed</mat-icon>
                        <span class="bm-chip__v">{{ a.bpm }} BPM</span>
                      </span>
                    }

                    @if (durationLabel(a.durationSec)) {
                      <span class="bm-chip">
                        <mat-icon class="bm-chip__ic">schedule</mat-icon>
                        <span class="bm-chip__v">{{ durationLabel(a.durationSec) }}</span>
                      </span>
                    }
                  </div>

                  @if (a.notes) {
                    <div class="bm-card__note">{{ a.notes }}</div>
                  }

                  <div class="bm-card__foot">Updated: {{ a.updatedAt | date: 'MMM d, y' }}</div>
                </mat-card>
              }
            </div>
          </div>
        } @else {
          <mat-card class="bm-empty">
            <div class="bm-empty__t">No arrangements available yet</div>
            <div class="bm-empty__s">This work doesnâ€™t have any playable arrangement.</div>
          </mat-card>
        }
      </div>
    </div>
  }
}
