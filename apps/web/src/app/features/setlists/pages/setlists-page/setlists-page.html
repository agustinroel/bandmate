<header class="d-flex align-items-start gap-3 mb-3">
  <div class="bm-mark" aria-hidden="true"><mat-icon>queue_music</mat-icon></div>
  <div class="flex-grow-1">
    <h2 class="m-0">Setlists</h2>
    <div class="small opacity-75 mt-1">Shape the flow of your rehearsal or show.</div>
  </div>
  <button mat-raised-button color="primary" class="sl-new" (click)="createSetlist()">
    <mat-icon class="me-1">add</mat-icon>
    New setlist
  </button>
</header>

@if (store.error()) {
  <div class="alert alert-danger">{{ store.error() }}</div>
}

<div class="sl-layout mt-2">
  <!-- Left: setlists -->
  <mat-card class="sl-panel">
    <div class="sl-panel-inner">
      <div class="fw-semibold mb-2">Your setlists</div>

      @if (store.state() === 'loading') {
        <div class="small opacity-75 py-2">Loading…</div>
      } @else if (store.items().length === 0) {
        <div class="small opacity-75 py-2">No setlists yet — create one to get started.</div>
      } @else {
        <div class="sl-list">
          @for (s of store.items(); track s.id) {
            <div
              class="sl-item"
              [attr.data-setlist-id]="s.id"
              [class.active]="store.selectedId() === s.id"
              (click)="store.select(s.id)"
              role="button"
              tabindex="0"
            >
              <div class="sl-item-row">
                <div class="sl-item-main">
                  <div class="fw-semibold text-truncate">{{ s.name }}</div>
                  <div class="small opacity-75">{{ s.items.length }} song(s)</div>
                </div>

                <button
                  mat-icon-button
                  type="button"
                  matTooltip="Rename setlist"
                  (click)="openRenameSetlist(s.id, s.name); $event.stopPropagation()"
                  aria-label="Rename"
                >
                  <mat-icon>edit</mat-icon>
                </button>

                <button
                  mat-icon-button
                  type="button"
                  matTooltip="Delete setlist"
                  (click)="askDeleteSetlist(s.id, s.name); $event.stopPropagation()"
                  aria-label="Delete"
                >
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
          }
        </div>
      }
    </div>
  </mat-card>

  <!-- Right: editor -->
  <mat-card class="sl-panel">
    <div class="sl-panel-inner">
      @if (!store.selected()) {
        <div class="text-center py-5 opacity-75">
          Pick a setlist on the left, or create a new one to begin.
        </div>
      } @else {
        <div class="d-flex align-items-start gap-2">
          <div class="sl-head">
            <div class="sl-head-title-row">
              <div class="sl-head-title">{{ store.selected()!.name }}</div>

              <!-- Should: rename from header -->
              <button
                mat-icon-button
                type="button"
                matTooltip="Rename setlist"
                (click)="openRenameSetlist(store.selected()!.id, store.selected()!.name)"
              >
                <mat-icon>edit</mat-icon>
              </button>
            </div>

            <div class="sl-head-meta">
              <div class="sl-pill">
                <mat-icon class="sl-pill-ic">schedule</mat-icon>
                <span class="sl-pill-label">Total</span>
                <span class="sl-pill-value">{{ totalDurationLabel() }}</span>
              </div>

              <div class="sl-pill">
                <mat-icon class="sl-pill-ic">music_note</mat-icon>
                <span class="sl-pill-label">Songs</span>
                <span class="sl-pill-value">{{ store.selected()!.items.length }}</span>
              </div>

              <div class="sl-head-actions">
                <!-- Must: disable start practice when empty + tooltip -->
                <button
                  mat-raised-button
                  color="primary"
                  type="button"
                  [disabled]="store.selected()!.items.length === 0"
                  [matTooltip]="
                    store.selected()!.items.length === 0
                      ? 'Add at least one song to start practicing'
                      : 'Start practicing this setlist'
                  "
                  [matTooltipDisabled]="false"
                  (click)="startPractice()"
                >
                  <mat-icon class="me-1">play_arrow</mat-icon>
                  Start practice
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="sl-grid mt-3">
          <!-- Available songs -->
          <div>
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="small fw-semibold">Add songs</div>
              <div class="small opacity-75">
                @if (songs.state() === 'loading') {
                  Loading…
                } @else {
                  {{ filteredSongs().length }} available
                }
              </div>
            </div>

            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Filter</mat-label>
              <input
                matInput
                [value]="songQuery()"
                (input)="songQuery.set($any($event.target).value)"
                [disabled]="songs.state() === 'loading'"
              />
            </mat-form-field>

            <div class="sl-songs">
              <!-- Must: songs loading state -->
              @if (songs.state() === 'loading') {
                <div class="sl-empty sl-empty-sm">
                  <mat-icon class="sl-empty-ic">hourglass_top</mat-icon>
                  <div class="fw-semibold mt-2">Loading songs…</div>
                  <div class="small opacity-75 mt-1">Just a second.</div>
                </div>
              } @else if (filteredSongs().length === 0) {
                <div class="sl-empty sl-empty-sm">
                  <mat-icon class="sl-empty-ic">check_circle</mat-icon>

                  @if (store.selected()?.items?.length) {
                    <div class="fw-semibold mt-2">All your songs are already in this setlist</div>
                    <div class="small opacity-75 mt-1">
                      Remove one on the right to add it again.
                    </div>
                  } @else if (songQuery()) {
                    <div class="fw-semibold mt-2">No matches found</div>
                    <div class="small opacity-75 mt-1">Try a different title or artist.</div>
                  } @else {
                    <div class="fw-semibold mt-2">No songs yet</div>
                    <div class="small opacity-75 mt-1">
                      Add songs to your library to build your first setlist.
                    </div>
                  }
                </div>
              } @else {
                @for (s of filteredSongs(); track s.id) {
                  <button class="sl-add" type="button" (click)="addSong(s.id)">
                    <div class="text-truncate">
                      <span class="fw-semibold">{{ s.title }}</span>
                      <span class="opacity-75"> — {{ s.artist }}</span>
                    </div>
                    <mat-icon>add</mat-icon>
                  </button>
                }
              }
            </div>
          </div>

          <!-- Current setlist -->
          <div>
            <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="small fw-semibold">Order</div>
              <!-- Nice: micro-hint -->
              <div class="small opacity-75 d-none d-lg-block">Drag to shape the flow</div>
            </div>

            @if (store.selected()!.items.length === 0) {
              <div class="sl-empty">
                <mat-icon class="sl-empty-ic">playlist_add</mat-icon>
                <div class="fw-semibold mt-2">Your setlist is empty</div>
                <div class="small opacity-75 mt-1">
                  Add songs on the left and arrange the order when you’re ready.
                </div>
              </div>
            } @else {
              <div cdkDropList class="sl-drop" (cdkDropListDropped)="drop($event)">
                @for (it of store.selected()!.items; track it.songId) {
                  <div class="sl-row" cdkDrag [class.moved]="it.songId === lastMovedId()">
                    <!-- Nice: real drag handle + tooltip -->
                    <mat-icon class="sl-grab" cdkDragHandle matTooltip="Drag to reorder"
                      >drag_indicator</mat-icon
                    >

                    <div class="flex-grow-1 min-w-0">
                      <div class="text-truncate fw-semibold">{{ songTitle(it.songId) }}</div>
                      <div class="small opacity-75">
                        {{ songArtist(it.songId) }}
                        @if (songDuration(it.songId)) {
                          <span class="ms-2">• {{ songDuration(it.songId) }}</span>
                        }
                      </div>
                    </div>

                    <button mat-icon-button type="button" (click)="removeSong(it.songId)">
                      <mat-icon>close</mat-icon>
                    </button>
                  </div>
                }
              </div>
            }
          </div>
        </div>
      }
    </div>
  </mat-card>
</div>
