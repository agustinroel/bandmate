<div class="profile-head">
  <div class="d-flex align-items-start gap-3 mb-3">
    <div class="bm-mark" aria-hidden="true">
      <mat-icon>person</mat-icon>
    </div>

    <div class="flex-grow-1">
      <h2 class="m-0">Profile</h2>
      <div class="small opacity-75">Your public presence on Bandmate.</div>
    </div>

    <div class="profile-actions">
      <button
        mat-stroked-button
        type="button"
        (click)="reset()"
        [disabled]="!isDirty() || state() !== 'ready'"
      >
        Reset
      </button>

      <button
        mat-raised-button
        color="primary"
        type="button"
        (click)="save()"
        [disabled]="!canSave()"
      >
        <mat-icon class="me-1">save</mat-icon>
        Save
      </button>
    </div>
  </div>
</div>

@if (state() === 'loading') {
  <div class="small opacity-75 mt-2">Loading profile…</div>
}

@if (state() === 'error') {
  <div class="alert alert-danger mt-2 d-flex align-items-center justify-content-between gap-2">
    <span>{{ error() }}</span>
    <button mat-stroked-button type="button" (click)="load()">
      <mat-icon class="me-1">refresh</mat-icon>
      Retry
    </button>
  </div>
}

@if (state() === 'ready' && draft(); as d) {
  <mat-card class="profile-card">
    <div class="profile-top">
      @if (avatarUrl()) {
        <img class="avatar" [src]="avatarUrl()!" alt="" aria-hidden="true" />
      } @else {
        <div class="avatar avatar--fallback" aria-hidden="true">
          <mat-icon>person</mat-icon>
        </div>
      }

      <div class="profile-ident">
        <div class="name">{{ displayName() }}</div>
        <div class="email opacity-75">{{ email() }}</div>

        <div class="public-row">
          <span class="small opacity-75">Public profile:</span>

          <code class="public-url">{{ publicProfileUrl() || '—' }}</code>

          <button
            mat-stroked-button
            type="button"
            class="copy-btn"
            (click)="copyPublicUrl()"
            [disabled]="!publicProfileUrl()"
          >
            <mat-icon class="me-1">content_copy</mat-icon>
            Copy
          </button>
        </div>
      </div>
    </div>

    <div class="form-grid">
      <!-- Username -->
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Username</mat-label>
        <input
          matInput
          [value]="d.username"
          (input)="setUsername($any($event.target).value)"
          placeholder="your_username"
          autocomplete="off"
        />

        @if (usernameError()) {
          <mat-hint class="text-danger">{{ usernameError() }}</mat-hint>
        } @else {
          <mat-hint>3–24 chars: letters, numbers or underscore</mat-hint>
        }
      </mat-form-field>

      <!-- About -->
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>About</mat-label>
        <textarea
          matInput
          rows="5"
          maxlength="280"
          [value]="d.about"
          (input)="setAbout($any($event.target).value)"
          placeholder="What do you play? What are you looking for? Any influences?"
        ></textarea>
        <mat-hint align="end">{{ d.about.length || 0 }}/280</mat-hint>
      </mat-form-field>

      <!-- Instruments -->
      <mat-card class="subcard">
        <div class="subhead">
          <div class="subttl">Instruments</div>
          <div class="subhint small opacity-75">Pick from the list</div>
        </div>

        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Select instruments</mat-label>
          <mat-select
            [value]="d.instruments"
            (selectionChange)="setInstruments($event.value)"
            multiple
          >
            @for (opt of instrumentOptions; track opt) {
              <mat-option [value]="opt">{{ opt }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        @if (d.instruments.length > 0) {
          <mat-chip-set class="chipset" aria-label="Selected instruments">
            @for (inst of d.instruments; track inst) {
              <mat-chip (removed)="removeInstrument(inst)">
                {{ inst }}
                <button matChipRemove aria-label="Remove instrument">
                  <mat-icon>close</mat-icon>
                </button>
              </mat-chip>
            }
          </mat-chip-set>
        } @else {
          <div class="small opacity-75">No instruments selected yet.</div>
        }
      </mat-card>

      <!-- Preferences -->
      <mat-card class="subcard">
        <div class="subhead">
          <div class="subttl">Preferences</div>
          <div class="subhint small opacity-75">MVP</div>
        </div>

        <div class="prefs-row">
          <mat-slide-toggle [checked]="d.sings" (change)="toggleSings($event.checked)">
            Sings
          </mat-slide-toggle>

          <mat-slide-toggle
            [checked]="d.publicProfile"
            (change)="togglePublicProfile($event.checked)"
          >
            Public profile
          </mat-slide-toggle>
        </div>

        <div class="prefs-row prefs-row--second">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Default chord instrument</mat-label>
            <mat-select
              [value]="d.chordDefaultInstrument"
              (selectionChange)="setChordDefaultInstrument($event.value)"
            >
              @for (opt of chordInstrumentOptions; track opt.id) {
                <mat-option [value]="opt.id">{{ opt.label }}</mat-option>
              }
            </mat-select>
            <mat-hint>Used as default in song view (later we’ll refine this).</mat-hint>
          </mat-form-field>
        </div>
      </mat-card>

      <!-- Genres -->
      <mat-card class="subcard">
        <div class="subhead">
          <div class="subttl">Genres</div>
          <div class="subhint small opacity-75">Pick what you play / listen to</div>
        </div>

        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Select genres</mat-label>
          <mat-select [value]="d.genres" (selectionChange)="setGenres($event.value)" multiple>
            @for (g of genreOptions; track g) {
              <mat-option [value]="g">{{ g }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        @if (d.genres.length > 0) {
          <mat-chip-set class="chipset" aria-label="Selected genres">
            @for (g of d.genres; track g) {
              <mat-chip (removed)="removeGenre(g)">
                {{ g }}
                <button matChipRemove aria-label="Remove genre">
                  <mat-icon>close</mat-icon>
                </button>
              </mat-chip>
            }
          </mat-chip-set>
        } @else {
          <div class="small opacity-75">No genres selected yet.</div>
        }
      </mat-card>

      <div class="profile-bottom-actions">
        <button
          mat-stroked-button
          type="button"
          (click)="reset()"
          [disabled]="!isDirty() || state() !== 'ready'"
        >
          Reset changes
        </button>

        <button
          mat-raised-button
          color="primary"
          type="button"
          (click)="save()"
          [disabled]="!canSave()"
        >
          <mat-icon class="me-1">save</mat-icon>
          Save
        </button>
      </div>
    </div>
  </mat-card>
}
