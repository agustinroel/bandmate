<div class="container py-4">
  @switch (state()) {
    @case ('loading') {
      <div class="d-flex justify-content-center py-5">
        <mat-spinner diameter="40"></mat-spinner>
      </div>
    }

    @case ('error') {
      <div class="error-state text-center py-5">
        <mat-icon class="icon-lg mb-3 text-danger">error_outline</mat-icon>
        <h2>Something went wrong</h2>
        <p class="opacity-75 mb-4">We couldn't load this profile.</p>
        <button mat-stroked-button (click)="goHome()">Go Home</button>
      </div>
    }

    @case ('not-found') {
      <div class="not-found-state text-center py-5">
        <mat-icon class="icon-lg mb-3 opacity-50">person_off</mat-icon>
        <h2>User not found</h2>
        <p class="opacity-75 mb-4">
          The user <strong>{{ usernameParam() }}</strong> does not exist or has changed their
          username.
        </p>
        <button mat-stroked-button (click)="goHome()">Go Home</button>
      </div>
    }

    @case ('loaded') {
      @if (isPrivate() && !isOwnProfile()) {
        <!-- Private Profile View -->
        <div class="private-state text-center py-5">
          <mat-icon class="icon-lg mb-3 opacity-50">lock</mat-icon>
          <h2>This profile is private</h2>
          <p class="opacity-75 mb-4">This user has chosen to keep their profile hidden.</p>
          <button mat-stroked-button (click)="goHome()">Go Home</button>
        </div>
      } @else {
        <!-- Public Profile View -->

        <mat-card class="profile-card mx-auto" appearance="outlined">
          <div class="profile-header">
            <!-- Cover / Gradient -->
            <div class="profile-cover"></div>

            <div class="profile-actions">
              <button mat-icon-button (click)="copyLink()" matTooltip="Copy Link">
                <mat-icon>content_copy</mat-icon>
              </button>
              @if (isOwnProfile()) {
                <a mat-icon-button routerLink="/profile" matTooltip="Edit Profile">
                  <mat-icon>edit</mat-icon>
                </a>
              } @else {
                <button mat-icon-button (click)="openInviteDialog()" matTooltip="Invite to Band">
                  <mat-icon>group_add</mat-icon>
                </button>
              }
            </div>

            <div class="profile-identity">
              <div class="profile-avatar">
                @if (profile()?.avatar_url) {
                  <img [src]="profile()?.avatar_url" (error)="handleAvatarError()" alt="Avatar" />
                } @else {
                  <mat-icon class="icon-xl">person</mat-icon>
                }
              </div>
              <h1 class="profile-name">{{ profile()?.full_name || profile()?.username }}</h1>
              <div class="profile-username">{{ '@' + profile()?.username }}</div>

              @if (profile()?.sings) {
                <div class="mt-2 text-center">
                  <div class="badge-sings">
                    <mat-icon class="icon-sm me-1">mic</mat-icon>
                    Sings
                  </div>
                </div>
              }
            </div>
          </div>

          <mat-card-content class="profile-body">
            @if (profile()?.about) {
              <div class="profile-bio">
                {{ profile()?.about }}
              </div>
            }

            <div class="profile-section">
              <div class="section-title">Instruments</div>
              @if (profile()?.instruments?.length) {
                <div class="chip-grid">
                  @for (inst of profile()?.instruments; track inst) {
                    <span class="bm-chip">{{ inst }}</span>
                  }
                </div>
              } @else {
                <div class="empty-text">No instruments listed</div>
              }
            </div>

            <div class="profile-section">
              <div class="section-title">Genres</div>
              @if (profile()?.genres?.length) {
                <div class="chip-grid">
                  @for (genre of profile()?.genres; track genre) {
                    <span class="bm-chip bm-chip-outline">{{ genre }}</span>
                  }
                </div>
              } @else {
                <div class="empty-text">No genres listed</div>
              }
            </div>

            <!-- Placeholder for Bands -->
            <div class="profile-section">
              <div class="section-title">Bands</div>
              @if (bands().length > 0) {
                <div class="d-flex flex-column gap-2">
                  @for (band of bands(); track band.id) {
                    <a
                      [routerLink]="['/bands', band.id]"
                      class="text-decoration-none text-reset d-block band-link"
                    >
                      <div
                        class="band-item d-flex align-items-center p-2 rounded border bg-white mb-2"
                      >
                        <div
                          class="band-avatar me-3 rounded-circle d-flex align-items-center justify-content-center text-white fw-bold"
                          style="width: 40px; height: 40px; background: var(--bm-primary)"
                        >
                          @if (band.avatar_url) {
                            <img
                              [src]="band.avatar_url"
                              class="w-100 h-100 rounded-circle object-fit-cover"
                            />
                          } @else {
                            {{ band.name.slice(0, 1).toUpperCase() }}
                          }
                        </div>
                        <div class="flex-grow-1">
                          <div class="fw-semibold">{{ band.name }}</div>
                          <div class="small opacity-75">
                            {{ band.my_roles.includes('owner') ? 'Owner' : 'Member' }}
                          </div>
                        </div>
                      </div>
                    </a>
                  }
                </div>
              } @else {
                <div class="empty-text">No bands yet</div>
              }
            </div>
          </mat-card-content>
        </mat-card>
      }
    }
  }
</div>
