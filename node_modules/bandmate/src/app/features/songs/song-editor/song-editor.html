<header class="bm-page-header">
  <div class="d-flex align-items-start gap-3">
    <button mat-icon-button class="bm-back" (click)="goBack()" aria-label="Back">
      <mat-icon>arrow_back</mat-icon>
    </button>

    <div class="bm-mark" aria-hidden="true">
      <mat-icon>{{ viewMode() === 'view' ? 'library_music' : 'edit' }}</mat-icon>
    </div>

    <div class="flex-grow-1 min-w-0">
      @if (currentDetail(); as d) {
        <!-- VIEW: título real -->
        @if (viewMode() === 'view') {
          <h2 class="m-0 text-truncate">{{ d.title }}</h2>
          <div class="small opacity-75 mt-1 text-truncate">{{ d.artist }}</div>
        } @else {
          <!-- EDIT: etiqueta de edición (pero sin “detalle” fake) -->
          <h2 class="m-0">Edit song</h2>
          <div class="small opacity-75 mt-1 text-truncate">{{ d.title }} — {{ d.artist }}</div>
        }
      } @else {
        <!-- NEW -->
        <h2 class="m-0">New song</h2>
        <div class="small opacity-75 mt-1">
          Add details now, and you’ll thank yourself at rehearsal.
        </div>
      }
    </div>

    <div class="bm-header-actions d-flex align-items-center gap-2">
      @if (isEdit() && canEditBody()) {
        <!-- chip autosave sólo en edit -->
        @if (saveUi() !== 'idle') {
          <div
            class="bm-save-chip"
            [class.is-saving]="saveUi() === 'saving'"
            [class.is-saved]="saveUi() === 'saved'"
            [class.is-error]="saveUi() === 'error'"
          >
            @if (saveUi() === 'saving') {
              <span class="bm-dot bm-dot--spin" aria-hidden="true"></span>
              <span>Autosaving</span>
            } @else if (saveUi() === 'saved') {
              <mat-icon class="bm-chip-ic">check</mat-icon>
              <span>Saved</span>
            } @else if (saveUi() === 'error') {
              <mat-icon class="bm-chip-ic">error_outline</mat-icon>
              <span>Save failed</span>
            }
          </div>
        }
      }

      @if (isEdit() && SongPolicy.canEdit(currentDetail())) {
        <button mat-stroked-button type="button" class="bm-edit-top" (click)="toggleMode()">
          <mat-icon class="bm-btn-ic">{{ viewMode() === 'view' ? 'edit' : 'visibility' }}</mat-icon>
          {{ viewMode() === 'view' ? 'Edit' : 'View' }}
        </button>
      }
    </div>
  </div>
</header>

@if (saving()) {
  <mat-progress-bar mode="indeterminate"></mat-progress-bar>
}

<mat-card
  class="bm-editor-card mt-3 mb-3"
  [class.bm-editor-card--autoscroll]="autoScrollOn()"
  #scrollHost
>
  <div class="bm-card-inner">
    @if (isDetailLoading()) {
      <div class="bm-editor-skeleton" aria-label="Loading song editor">
        <div class="sk-row sk-row--top">
          <div class="sk-block sk-title"></div>
          <div class="sk-block sk-sub"></div>
        </div>

        <div class="sk-form">
          <div class="sk-block sk-input"></div>
          <div class="sk-block sk-input"></div>
          <div class="sk-block sk-input sk-input--sm"></div>
          <div class="sk-actions">
            <div class="sk-block sk-btn"></div>
            <div class="sk-block sk-btn"></div>
          </div>
        </div>

        <div class="sk-body">
          <div class="sk-block sk-body-title"></div>
          <div class="sk-block sk-body-sub"></div>

          <div class="sk-section">
            <div class="sk-block sk-sec-title"></div>
            <div class="sk-block sk-line"></div>
            <div class="sk-block sk-line sk-line--short"></div>
          </div>

          <div class="sk-section">
            <div class="sk-block sk-sec-title"></div>
            <div class="sk-block sk-line"></div>
            <div class="sk-block sk-line sk-line--short"></div>
          </div>
        </div>
      </div>
    } @else {
      @if (store.error() || store.selectedError()) {
        <div class="alert alert-danger mb-3">
          {{ store.error() || store.selectedError() }}
        </div>
      }

      @if (currentDetail(); as d) {
        @if (viewMode() === 'view') {
          <!-- META VIEW (premium, para tocar) -->
          <div class="bm-meta-view">
            <div class="bm-meta-title">{{ d.title }}</div>
            <div class="bm-meta-artist opacity-75">{{ d.artist }}</div>

            @if (d.key || d.bpm || d.durationSec) {
              <div class="bm-meta-pills">
                @if (d.key) {
                  <span class="bm-pill">
                    <mat-icon class="bm-pill-ic">music_note</mat-icon>
                    Key: {{ d.key }}
                  </span>
                }

                @if (d.bpm) {
                  <span class="bm-pill">
                    <mat-icon class="bm-pill-ic">speed</mat-icon>
                    {{ d.bpm }} BPM
                  </span>
                }

                @if (d.durationSec) {
                  <span class="bm-pill">
                    <mat-icon class="bm-pill-ic">schedule</mat-icon>
                    {{ durationLabel(d.durationSec) }}
                  </span>
                }
              </div>
            }

            @if (d.notes) {
              <div class="bm-meta-notes">
                <div class="bm-meta-notes-h">NOTES</div>
                <div class="bm-meta-notes-t">{{ d.notes }}</div>
              </div>
            }
          </div>
        } @else {
          <!-- META EDIT -->
          <app-song-form
            [initial]="d"
            [onSubmit]="save"
            [onCancel]="goBack"
            [onDraftChange]="onMetaDraftChange"
          />
        }
      } @else {
        <!-- NEW (si querés: mostrar form igual) -->
        <app-song-form
          [initial]="undefined"
          [onSubmit]="save"
          [onCancel]="goBack"
          [onDraftChange]="onMetaDraftChange"
        />
      }

      <!-- Body (sections/lines) - available both in NEW and EDIT -->
      @if (currentDetail()) {
        <div class="bm-body mt-4">
          <div class="bm-body-head">
            <div class="min-w-0">
              <div class="bm-body-title">Song body</div>

              @if (canEditBody()) {
                <div class="bm-body-sub">
                  Sections help you structure the song (Verse, Chorus, Bridge…)
                </div>
              } @else {
                <div class="bm-body-sub bm-body-sub--play">Transpose & play</div>
              }
            </div>

            <div class="bm-body-actions">
              @if (viewMode() !== 'edit') {
                <div class="bm-auto-scroll">
                  <button
                    mat-stroked-button
                    type="button"
                    class="bm-auto-btn"
                    (click)="toggleAutoScroll()"
                    [disabled]="!canAutoScroll()"
                  >
                    <mat-icon class="bm-btn-ic">{{
                      autoScrollOn() ? 'pause' : 'play_arrow'
                    }}</mat-icon>

                    <span class="bm-auto-label">Auto-scroll</span>

                    @if (autoScrollOn()) {
                      <span class="bm-auto-speed small opacity-75"
                        >{{ autoScrollSpeed() }} px/s</span
                      >
                    }
                  </button>

                  <button
                    mat-icon-button
                    type="button"
                    class="bm-auto-tune"
                    [matMenuTriggerFor]="autoScrollMenu"
                    aria-label="Auto-scroll speed"
                  >
                    <mat-icon>tune</mat-icon>
                  </button>

                  <mat-menu #autoScrollMenu="matMenu" overlapTrigger="false">
                    <div class="px-3 py-2 small opacity-75">Speed</div>

                    <button mat-menu-item (click)="setAutoScrollSpeed(18)">
                      <mat-icon>slow_motion_video</mat-icon>
                      Slow
                    </button>

                    <button mat-menu-item (click)="setAutoScrollSpeed(28)">
                      <mat-icon>speed</mat-icon>
                      Normal
                    </button>

                    <button mat-menu-item (click)="setAutoScrollSpeed(40)">
                      <mat-icon>bolt</mat-icon>
                      Fast
                    </button>
                  </mat-menu>
                </div>
              }

              @if (displayKey(); as k) {
                <div class="bm-key-pill">
                  <mat-icon class="bm-btn-ic">music_note</mat-icon>
                  Key: {{ k }}
                </div>
              }

              <div class="bm-transpose">
                <button
                  mat-stroked-button
                  type="button"
                  class="bm-tr-btn"
                  (click)="transposeSong(-1)"
                >
                  <mat-icon class="bm-btn-ic">remove</mat-icon>
                </button>

                <div class="bm-tr-label">Transpose</div>

                <button
                  mat-stroked-button
                  type="button"
                  class="bm-tr-btn"
                  (click)="transposeSong(1)"
                >
                  <mat-icon class="bm-btn-ic">add</mat-icon>
                </button>
              </div>

              @if (canEditBody()) {
                <button
                  mat-stroked-button
                  class="bm-add-section"
                  color="primary"
                  type="button"
                  (click)="addSection()"
                >
                  <mat-icon class="bm-btn-ic">add</mat-icon>
                  Add section
                </button>
              }
            </div>
          </div>

          @if ((currentDetail()!.sections.length || 0) === 0) {
            <div class="bm-empty">
              <div class="bm-empty-ic">
                <mat-icon>queue_music</mat-icon>
              </div>
              <div class="bm-empty-title">No sections yet</div>
              <div class="bm-empty-sub">
                Start with a Verse and a Chorus, then we’ll add lines and chords.
              </div>
            </div>
          } @else {
            <div class="bm-section-list">
              @for (sec of currentDetail()!.sections; track sec.id) {
                <div class="bm-section-card">
                  <div class="bm-section-top">
                    <div class="bm-section-name">
                      {{ sec.name || (sec.type | titlecase) }}
                    </div>

                    <div class="d-flex align-items-center gap-2">
                      <div class="bm-section-meta">{{ sec.type }} · #{{ sec.order }}</div>

                      @if (canEditBody()) {
                        <button
                          mat-stroked-button
                          type="button"
                          class="bm-add-line"
                          (click)="addLine(sec.id)"
                        >
                          <mat-icon class="bm-btn-ic">add</mat-icon>
                          Add line
                        </button>

                        <button
                          mat-icon-button
                          type="button"
                          class="bm-sec-edit"
                          aria-label="Edit section"
                          (click)="editSection(sec); $event.stopPropagation()"
                        >
                          <mat-icon>edit</mat-icon>
                        </button>

                        <button
                          mat-icon-button
                          type="button"
                          class="bm-sec-del"
                          aria-label="Delete section"
                          (click)="deleteSection(sec.id); $event.stopPropagation()"
                        >
                          <mat-icon>delete</mat-icon>
                        </button>
                      }
                    </div>
                  </div>

                  <div class="bm-lines">
                    @for (line of sec.lines; track line.id) {
                      @if (line.kind === 'lyrics') {
                        @if (canEditBody()) {
                          <div class="bm-line-row">
                            <textarea
                              class="bm-line-input"
                              rows="2"
                              placeholder="Type lyrics and chords like: [Am]Hello [G]world"
                              [value]="line.source ?? ''"
                              (input)="onLineInput(sec.id, line.id, $any($event.target).value)"
                            ></textarea>

                            <button
                              mat-icon-button
                              type="button"
                              class="bm-line-del"
                              aria-label="Delete line"
                              (click)="deleteLine(sec.id, line.id); $event.stopPropagation()"
                            >
                              <mat-icon>close</mat-icon>
                            </button>
                          </div>
                        }

                        @let src = transposeInlineChords(line.source ?? '', transpose());

                        <!-- MOBILE: Flow mode (wrap, NO horizontal scroll) -->
                        <div class="bm-flow" aria-label="Chord flow">
                          @for (t of flowTokens(src); track $index) {
                            <span class="bm-flow-token" [class.has-chord]="!!t.chord">
                              @if (t.chord) {
                                <button
                                  type="button"
                                  class="bm-chord-hit bm-flow-chord"
                                  [class.is-hovered]="hoveredChord() === t.chord"
                                  [class.is-selected]="selectedChord() === t.chord"
                                  [matMenuTriggerFor]="viewMode() === 'view' ? chordMenu : null"
                                  (mouseenter)="hoveredChord.set(t.chord)"
                                  (mouseleave)="
                                    hoveredChord.set(
                                      hoveredChord() === t.chord ? null : hoveredChord()
                                    )
                                  "
                                  (focus)="hoveredChord.set(t.chord)"
                                  (blur)="
                                    hoveredChord.set(
                                      hoveredChord() === t.chord ? null : hoveredChord()
                                    )
                                  "
                                  (click)="selectedChord.set(t.chord)"
                                  (menuOpened)="selectedChord.set(t.chord)"
                                  aria-label="Chord {{ t.chord }}"
                                >
                                  {{ t.chord }}
                                </button>
                              } @else {
                                <span class="bm-flow-chord bm-flow-chord--ghost"></span>
                              }
                              <span class="bm-flow-text">{{ t.text }}</span>
                            </span>
                          }
                        </div>

                        @let built = buildLayout(src);

                        <div class="bm-chart-desktop" aria-label="Chord chart desktop">
                          <div
                            class="bm-chart-line bm-chart-chords bm-chords-clickable"
                            aria-label="Chords"
                          >
                            @for (p of built.chords; track p.pos + '_' + p.chord) {
                              <span
                                class="bm-chord-slot"
                                [style.paddingLeft.ch]="chPad(p.pos, $index, built.chords)"
                              >
                                <button
                                  type="button"
                                  class="bm-chord-hit"
                                  [class.is-hovered]="hoveredChord() === p.chord"
                                  [class.is-selected]="selectedChord() === p.chord"
                                  [matMenuTriggerFor]="viewMode() === 'view' ? chordMenu : null"
                                  (mouseenter)="hoveredChord.set(p.chord)"
                                  (mouseleave)="
                                    hoveredChord.set(
                                      hoveredChord() === p.chord ? null : hoveredChord()
                                    )
                                  "
                                  (focus)="hoveredChord.set(p.chord)"
                                  (blur)="
                                    hoveredChord.set(
                                      hoveredChord() === p.chord ? null : hoveredChord()
                                    )
                                  "
                                  (click)="selectedChord.set(p.chord)"
                                  (menuOpened)="selectedChord.set(p.chord)"
                                  aria-label="Chord {{ p.chord }}"
                                >
                                  {{ p.chord }}
                                </button>
                              </span>
                            }
                          </div>

                          <div class="bm-chart-line bm-chart-lyrics">{{ built.lyrics }}</div>
                        </div>
                      }
                    }
                  </div>

                  <mat-menu
                    #chordMenu="matMenu"
                    class="bm-chord-menu"
                    yPosition="above"
                    overlapTrigger="false"
                  >
                    <div class="bm-chord-menu-inner" (click)="$event.stopPropagation()">
                      @if (chordInfo(); as info) {
                        <div class="bm-chord-menu-title">{{ info.raw }}</div>
                        <div class="bm-chord-menu-sub small opacity-75">
                          {{ info.root }} · {{ info.quality }}
                        </div>

                        <div class="bm-chord-section-title">Notes</div>

                        <div class="bm-chord-notes">
                          @for (n of info.notes; track n) {
                            <span class="bm-note-pill">{{ n }}</span>
                          }
                        </div>

                        <div class="bm-chord-section-title">Guitar</div>

                        <div class="bm-shapes">
                          @let shapes = info.shapes;
                          @let total = shapes.length;
                          @let idx = chordShapeIndex();

                          @if (total === 0) {
                            <div class="bm-shape-empty small opacity-75">
                              No guitar shape yet for this chord (MVP).
                            </div>
                          } @else {
                            @let sh = shapeAt(shapes, idx);

                            <div class="bm-shape-head">
                              <div class="bm-shape-left">
                                <div class="bm-shape-title">{{ sh.name }}</div>
                                @if (total > 1) {
                                  <div class="bm-shape-count">{{ idx + 1 }} / {{ total }}</div>
                                }
                              </div>
                            </div>

                            <div class="bm-shape-stage">
                              @if (total > 1) {
                                <button
                                  type="button"
                                  class="bm-shape-arrow bm-shape-arrow--left"
                                  aria-label="Previous shape"
                                  (click)="prevShape(total); $event.stopPropagation()"
                                >
                                  <mat-icon>chevron_left</mat-icon>
                                </button>
                              }

                              <div class="bm-shape-diagram">
                                <bm-guitar-chord-diagram
                                  [shape]="sh"
                                  [ariaLabel]="'Guitar chord ' + info.raw"
                                ></bm-guitar-chord-diagram>
                              </div>

                              @if (total > 1) {
                                <button
                                  type="button"
                                  class="bm-shape-arrow bm-shape-arrow--right"
                                  aria-label="Next shape"
                                  (click)="nextShape(total); $event.stopPropagation()"
                                >
                                  <mat-icon>chevron_right</mat-icon>
                                </button>
                              }
                            </div>
                          }
                        </div>
                      } @else {
                        <div class="small opacity-75">No chord selected</div>
                      }
                    </div>
                  </mat-menu>
                </div>
              }
            </div>
          }
        </div>
      }

      <!-- Hard error state for edit routes when detail couldn't be loaded -->
      @if (isEdit() && !currentDetail() && store.detailState() === 'error') {
        <div class="text-center py-5">
          <mat-icon style="font-size: 56px; height: 56px; width: 56px" class="opacity-50">
            error_outline
          </mat-icon>

          <div class="mt-3 fw-semibold">Song not found</div>
          <div class="small opacity-75 mb-3">
            This can happen if you opened the editor directly without loading the list.
          </div>

          <button mat-stroked-button color="primary" (click)="goBack()">Back to songs</button>
        </div>
      }
    }
  </div>
</mat-card>
