<header class="d-flex align-items-start gap-3 mb-3">
  <div class="bm-mark" aria-hidden="true">
    <mat-icon>sports_guitar</mat-icon>
  </div>

  <div class="flex-grow-1">
    <h2 class="m-0">Practice</h2>

    @if (p.setlist()) {
      <div class="small opacity-75 mt-1">
        {{ p.setlist()!.name }} • <span class="fw-semibold">{{ p.progressLabel() }}</span>
      </div>

      <div class="p-top-meta small mt-1">
        <span class="p-pill">
          <mat-icon class="p-pill-ic">schedule</mat-icon>
          Total: <span class="fw-semibold">{{ p.totalLabel() }}</span>
        </span>

        <span class="p-pill">
          <mat-icon class="p-pill-ic">trending_up</mat-icon>
          Elapsed: <span class="fw-semibold">{{ p.elapsedLabel() }}</span>
        </span>

        <span class="p-pill">
          <mat-icon class="p-pill-ic">hourglass_bottom</mat-icon>
          Remaining: <span class="fw-semibold">{{ p.remainingLabel() }}</span>
        </span>

        <div class="p-hotkeys small opacity-75 mt-2">
          Hotkeys:
          <span class="fw-semibold">Space</span>/<span class="fw-semibold">→</span> next,
          <span class="fw-semibold">←</span> previous, <span class="fw-semibold">R</span> restart,
          <span class="fw-semibold">Esc</span> exit
        </div>
      </div>
    } @else if (hasId()) {
      <div class="small opacity-75 mt-1">Loading setlist…</div>
    } @else {
      <div class="small opacity-75 mt-1">Select a setlist to start.</div>
    }
  </div>

  <button mat-stroked-button class="exit-button" type="button" (click)="exit()">
    <mat-icon class="me-1">close</mat-icon>
    Exit
  </button>
</header>

@if (!hasId()) {
  <mat-card class="p-card">
    <div class="p-empty">
      <mat-icon class="p-empty-ic">queue_music</mat-icon>
      <div class="fw-semibold mt-2">Choose a setlist to practice</div>
      <div class="small opacity-75 mt-1">
        Choose a setlist to practice Go to Setlists and press “Start practice” when you’re ready.
      </div>
      <button mat-raised-button color="primary" class="mt-3" (click)="goSetlists()">
        Go to setlists
      </button>
    </div>
  </mat-card>
} @else if (notFound()) {
  <mat-card class="p-card">
    <div class="p-empty">
      <mat-icon class="p-empty-ic">search_off</mat-icon>
      <div class="fw-semibold mt-2">Setlist not found</div>
      <div class="small opacity-75 mt-1">
        It may have been deleted, or the link is no longer valid.
      </div>
      <button mat-raised-button color="primary" class="mt-3" (click)="goSetlists()">
        Go to setlists
      </button>
    </div>
  </mat-card>
} @else if (!p.setlist()) {
  <mat-progress-bar mode="indeterminate"></mat-progress-bar>
} @else if (p.count() === 0) {
  <mat-card class="p-card">
    <div class="p-empty">
      <mat-icon class="p-empty-ic">playlist_add</mat-icon>
      <div class="fw-semibold mt-2">This setlist is empty</div>
      <div class="small opacity-75 mt-1">Add a few songs first, then come back to practice.</div>
      <button mat-raised-button color="primary" class="mt-3" (click)="goSetlists()">
        Go to setlists
      </button>
    </div>
  </mat-card>
} @else {
  <div class="p-grid">
    <!-- NOW -->
    <mat-card class="p-card p-now">
      <div class="p-kicker">NOW PLAYING</div>

      <div class="p-swap" [@slideSwap]="p.index()">
        @if (p.currentSong()) {
          <div class="p-title">{{ p.currentSong()!.title }}</div>
          <div class="p-sub opacity-75">{{ p.currentSong()!.artist }}</div>

          <div class="p-meta mt-3">
            @if (p.currentSong()!.key) {
              <span class="p-chip">Key: {{ p.currentSong()!.key }}</span>
            }
            @if (p.currentSong()!.bpm) {
              <span class="p-chip">BPM: {{ p.currentSong()!.bpm }}</span>
            }
            @if (durationLabel(p.currentSong()!.durationSec)) {
              <span class="p-chip">Dur: {{ durationLabel(p.currentSong()!.durationSec) }}</span>
            }
          </div>

          @if (p.currentSong()!.notes) {
            <div class="p-notes mt-3">
              <div class="small fw-semibold mb-1">Notes</div>
              <div class="small opacity-75">{{ p.currentSong()!.notes }}</div>
            </div>
          }
        }
      </div>

      <div class="p-controls mt-4">
        <button mat-stroked-button type="button" (click)="p.prev()" [disabled]="!p.prevSongId()">
          <mat-icon class="me-1">skip_previous</mat-icon>
          Prev
        </button>

        <!-- Nice: show Restart when end -->
        @if (!p.nextSongId()) {
          <button
            mat-raised-button
            color="primary"
            type="button"
            (click)="p.jumpTo(0)"
            matTooltip="Restart the setlist"
          >
            <mat-icon class="me-1">replay</mat-icon>
            Restart
          </button>
        } @else {
          <button
            mat-raised-button
            color="primary"
            type="button"
            (click)="p.next()"
            [disabled]="!p.nextSongId()"
            matTooltip="Next song"
          >
            Next
            <mat-icon class="ms-1">skip_next</mat-icon>
          </button>
        }
      </div>
    </mat-card>

    <!-- NEXT -->
    <mat-card class="p-card p-next">
      <div class="p-kicker">UP NEXT</div>
      <div class="p-swap" [@slideSwap]="p.index()">
        @if (p.nextSong()) {
          <div class="p-title-sm">{{ p.nextSong()!.title }}</div>
          <div class="small opacity-75">{{ p.nextSong()!.artist }}</div>

          <div class="small opacity-75 mt-2">
            @if (durationLabel(p.nextSong()!.durationSec)) {
              <span>Duration: {{ durationLabel(p.nextSong()!.durationSec) }}</span>
            } @else {
              <span>Duration: —</span>
            }
          </div>
        } @else {
          <div class="p-done">
            <mat-icon class="p-done-ic">task_alt</mat-icon>
            <div class="fw-semibold mt-2">End of setlist</div>
            <div class="small opacity-75 mt-1">Nice run. Want to play it again?</div>
          </div>
        }
      </div>
    </mat-card>
  </div>
}
