<header class="d-flex align-items-start gap-3 mb-3">
  <div class="bm-mark" aria-hidden="true">
    <mat-icon>sports_guitar</mat-icon>
  </div>

  <div class="flex-grow-1">
    <h2 class="m-0">Practice</h2>

    @if (p.setlist()) {
      <div class="small opacity-75 mt-1">
        {{ p.setlist()!.name }} • <span class="fw-semibold">{{ p.progressLabel() }}</span>
      </div>

      <div class="p-top-meta small mt-1">
        <span class="p-pill">
          <mat-icon class="p-pill-ic">schedule</mat-icon>
          Total: <span class="fw-semibold">{{ p.totalLabel() }}</span>
        </span>

        <span class="p-pill">
          <mat-icon class="p-pill-ic">trending_up</mat-icon>
          Elapsed: <span class="fw-semibold">{{ p.elapsedLabel() }}</span>
        </span>

        <span class="p-pill">
          <mat-icon class="p-pill-ic">hourglass_bottom</mat-icon>
          Remaining: <span class="fw-semibold">{{ p.remainingLabel() }}</span>
        </span>

        <div class="p-hotkeys small opacity-75 mt-2">
          Hotkeys:
          <span class="fw-semibold">Space</span>/<span class="fw-semibold">→</span> next,
          <span class="fw-semibold">←</span> previous, <span class="fw-semibold">R</span> restart,
          <span class="fw-semibold">Esc</span> exit
        </div>
      </div>
    } @else if (hasId()) {
      <div class="small opacity-75 mt-1">Loading setlist…</div>
    } @else {
      <div class="small opacity-75 mt-1">Select a setlist to start.</div>
    }
  </div>

  <div class="d-flex align-items-center gap-2">
    <!-- Metronome -->
    <div class="p-metronome">
      <button
        mat-icon-button
        type="button"
        class="p-metronome-btn"
        [color]="metronome.isPlaying() ? 'accent' : ''"
        (click)="metronome.toggle()"
        matTooltip="Metronome (Click to play/stop)"
      >
        <mat-icon>{{ metronome.isPlaying() ? 'volume_up' : 'timer' }}</mat-icon>
      </button>

      <button
        mat-button
        type="button"
        class="p-bpm-btn"
        [matMenuTriggerFor]="bpmMenu"
        matTooltip="Change BPM"
      >
        {{ metronome.bpm() }}
      </button>

      <mat-menu #bpmMenu="matMenu">
        <div class="p-bpm-panel" (click)="$event.stopPropagation()">
          <div class="small opacity-75 mb-2">Tempo (BPM)</div>
          <mat-slider min="40" max="220" step="1" showTickMarks discrete>
            <input
              matSliderThumb
              [value]="metronome.bpm()"
              (valueChange)="metronome.setBpm($event)"
            />
          </mat-slider>
          <div class="d-flex justify-content-between mt-1">
            <button mat-icon-button (click)="metronome.setBpm(metronome.bpm() - 5)">
              <mat-icon>remove</mat-icon>
            </button>
            <span class="fw-bold fs-5">{{ metronome.bpm() }}</span>
            <button mat-icon-button (click)="metronome.setBpm(metronome.bpm() + 5)">
              <mat-icon>add</mat-icon>
            </button>
          </div>
        </div>
      </mat-menu>
    </div>

    <button mat-stroked-button class="exit-button m-0" type="button" (click)="exit()">
      <mat-icon class="me-1">close</mat-icon>
      Exit
    </button>
  </div>
</header>

@if (!hasId()) {
  <mat-card class="p-card">
    <div class="p-empty">
      <mat-icon class="p-empty-ic">queue_music</mat-icon>
      <div class="fw-semibold mt-2">Choose a setlist to practice</div>
      <div class="small opacity-75 mt-1">
        Choose a setlist to practice Go to Setlists and press “Start practice” when you’re ready.
      </div>
      <button mat-raised-button color="primary" class="mt-3" (click)="goSetlists()">
        Go to setlists
      </button>
    </div>
  </mat-card>
} @else if (notFound()) {
  <mat-card class="p-card">
    <div class="p-empty">
      <mat-icon class="p-empty-ic">search_off</mat-icon>
      <div class="fw-semibold mt-2">Setlist not found</div>
      <div class="small opacity-75 mt-1">
        It may have been deleted, or the link is no longer valid.
      </div>
      <button mat-raised-button color="primary" class="mt-3" (click)="goSetlists()">
        Go to setlists
      </button>
    </div>
  </mat-card>
} @else if (!p.setlist()) {
  <mat-progress-bar mode="indeterminate"></mat-progress-bar>
} @else if (p.count() === 0) {
  <mat-card class="p-card">
    <div class="p-empty">
      <mat-icon class="p-empty-ic">playlist_add</mat-icon>
      <div class="fw-semibold mt-2">This setlist is empty</div>
      <div class="small opacity-75 mt-1">Add a few songs first, then come back to practice.</div>
      <button mat-raised-button color="primary" class="mt-3" (click)="goSetlists()">
        Go to setlists
      </button>
    </div>
  </mat-card>
} @else {
  <div class="p-grid" [class.stage-mode-active]="isStageMode()">
    <!-- NOW -->
    <mat-card class="p-card p-now">
      <button
        class="stage-toggle-btn"
        mat-icon-button
        (click)="toggleStageMode()"
        matTooltip="Toggle Full Screen (Stage Mode)"
      >
        <mat-icon>{{ isStageMode() ? 'close_fullscreen' : 'fullscreen' }}</mat-icon>
      </button>

      <div class="p-kicker">NOW PLAYING</div>

      <div class="p-swap" [@slideSwap]="p.index()">
        @if (p.currentSong()) {
          <div class="p-title">{{ p.currentSong()!.title }}</div>
          <div class="p-sub opacity-75">{{ p.currentSong()!.artist }}</div>

          <div
            class="p-meta mt-3 d-flex align-items-center justify-content-between flex-wrap gap-2"
          >
            <div class="d-flex flex-wrap gap-2 align-items-center">
              @if (p.currentSong()!.key) {
                <span class="p-chip">Key: {{ p.currentSong()!.key }}</span>
              }
              @if (p.currentSong()!.bpm) {
                <span class="p-chip">BPM: {{ p.currentSong()!.bpm }}</span>
              }
              @if (durationLabel(p.currentSong()!.durationSec)) {
                <span class="p-chip">Dur: {{ durationLabel(p.currentSong()!.durationSec) }}</span>
              }

              <!-- Auto-scroll FAB -->
            </div>

            <bm-transpose-bar [value]="transpose()" [onChange]="transpose" />
          </div>

          @if (p.currentSong()!.notes) {
            <div class="p-notes mt-3">
              <div class="small fw-semibold mb-1">Notes</div>
              <div class="small opacity-75">{{ p.currentSong()!.notes }}</div>
            </div>
          }

          <div class="mt-4">
            <app-song-viewer [songId]="p.currentSong()!.id" [transpose]="transpose()" />
          </div>
        }
      </div>
    </mat-card>

    <!-- NEXT -->
    <mat-card class="p-card p-next">
      <div class="p-kicker">UP NEXT</div>
      <div class="p-swap" [@slideSwap]="p.index()">
        @if (p.nextSong()) {
          <div class="p-title-sm">{{ p.nextSong()!.title }}</div>
          <div class="small opacity-75">{{ p.nextSong()!.artist }}</div>

          <div class="small opacity-75 mt-2">
            @if (durationLabel(p.nextSong()!.durationSec)) {
              <span>Duration: {{ durationLabel(p.nextSong()!.durationSec) }}</span>
            } @else {
              <span>Duration: —</span>
            }
          </div>
        } @else {
          <div class="p-done">
            <mat-icon class="p-done-ic">task_alt</mat-icon>
            <div class="fw-semibold mt-2">End of setlist</div>
            <div class="small opacity-75 mt-1">Nice run. Want to play it again?</div>
          </div>
        }
      </div>
    </mat-card>
  </div>

  <!-- Sticky Practice Toolbar -->
  <div class="p-toolbar" [class.p-toolbar-hidden]="!isToolbarVisible()">
    <!-- Group 1: Auto-scroll -->
    <div class="p-tb-group">
      <button
        mat-fab
        extended
        [color]="isScrolling() ? 'accent' : 'primary'"
        (click)="toggleScroll()"
        matTooltip="Auto-scroll (Hotkeys: 'S')"
      >
        <mat-icon>{{ isScrolling() ? 'pause' : 'play_arrow' }}</mat-icon>
        {{ isScrolling() ? 'Stop' : 'Scroll' }}
      </button>

      <div class="p-speed">
        <div class="small fw-semibold opacity-75">Speed</div>
        <mat-slider [min]="autoScrollSpeedMin" [max]="autoScrollSpeedMax" step="2">
          <input
            matSliderThumb
            [value]="autoScrollSpeed()"
            (valueChange)="setScrollSpeed($event)"
          />
        </mat-slider>
      </div>
    </div>

    <!-- Group 2: Song Nav -->
    <div class="p-tb-group p-tb-center">
      <button
        mat-icon-button
        (click)="p.prev()"
        [disabled]="!p.prevSongId()"
        matTooltip="Previous Song"
      >
        <mat-icon>skip_previous</mat-icon>
      </button>

      <div class="p-prog">
        <span class="fs-5 fw-bold">{{ p.index() + 1 }}</span>
        <span class="opacity-50">/</span>
        <span class="opacity-75">{{ p.count() }}</span>
      </div>

      <button
        mat-icon-button
        (click)="p.next()"
        [disabled]="!p.nextSongId()"
        matTooltip="Next Song"
      >
        <mat-icon>skip_next</mat-icon>
      </button>
    </div>

    <!-- Quick Section Jump Rail (Floating Right) -->
    @if (currentSections().length > 0) {
      <div
        class="p-section-rail d-none d-lg-flex flex-column position-fixed"
        [style.right.px]="isStageMode() ? 32 : 24"
        style="z-index: 100; gap: 8px"
      >
        @for (sec of currentSections(); track sec.id) {
          <button
            mat-mini-fab
            color="basic"
            class="section-jump-btn shadow-sm"
            style="opacity: 0.85; font-weight: 700; font-size: 0.75rem"
            (click)="scrollToSection(sec.id)"
            [matTooltip]="sec.name || (sec.type | titlecase)"
          >
            {{ (sec.name || sec.type).substring(0, 2).toUpperCase() }}
          </button>
        }
      </div>
    }

    <!-- Group 3: Sections & Restart -->
    <div class="p-tb-group justify-content-end">
      <!-- Sections Menu -->
      @if (currentSections().length) {
        <button mat-stroked-button [matMenuTriggerFor]="sectionsMenu">
          <mat-icon class="me-1">segment</mat-icon>
          Sections
        </button>
        <mat-menu #sectionsMenu="matMenu">
          @for (sec of currentSections(); track sec.id) {
            <button mat-menu-item (click)="scrollToSection(sec.id)">
              <span class="opacity-75 me-2">{{ sec.type }}</span>
              <span class="fw-semibold">{{ sec.name || (sec.type | titlecase) }}</span>
            </button>
          }
        </mat-menu>
      }

      <!-- Restart button (only if at end or explicit need) -->
      <button mat-icon-button (click)="p.jumpTo(0)" matTooltip="Restart Setlist">
        <mat-icon>replay</mat-icon>
      </button>
    </div>
  </div>
}
