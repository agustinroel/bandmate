@let builtLine = built();

@if (isProgressionOnly()) {
  <div class="bm-prog" aria-label="Chord progression">
    @for (p of builtLine.chords; track p.pos + '_' + p.chord) {
      <button
        type="button"
        class="bm-chord-hit"
        [class.is-hovered]="hoveredChord() === p.chord"
        [class.is-selected]="selectedChord() === p.chord"
        (mouseenter)="hoveredChord.set(p.chord)"
        (mouseleave)="hoveredChord.set(hoveredChord() === p.chord ? null : hoveredChord())"
        (focus)="hoveredChord.set(p.chord)"
        (blur)="hoveredChord.set(hoveredChord() === p.chord ? null : hoveredChord())"
        (click)="selectedChord.set(p.chord)"
        [attr.aria-label]="'Chord ' + p.chord"
        [matMenuTriggerFor]="interactive ? chordMenu : null"
        (menuOpened)="selectedChord.set(p.chord)"
      >
        {{ p.chord }}
      </button>
    }
  </div>
} @else {
  @if (mode === 'flow') {
    <div class="bm-flow" aria-label="Chord flow">
      @for (t of flow(); track $index) {
        <span class="bm-flow-token" [class.has-chord]="!!t.chord">
          @if (t.chord) {
            <button
              type="button"
              class="bm-chord-hit bm-flow-chord"
              [class.is-hovered]="hoveredChord() === t.chord"
              [class.is-selected]="selectedChord() === t.chord"
              (mouseenter)="hoveredChord.set(t.chord)"
              (mouseleave)="hoveredChord.set(hoveredChord() === t.chord ? null : hoveredChord())"
              (focus)="hoveredChord.set(t.chord)"
              (blur)="hoveredChord.set(hoveredChord() === t.chord ? null : hoveredChord())"
              (click)="selectedChord.set(t.chord)"
              [attr.aria-label]="'Chord ' + t.chord"
              [matMenuTriggerFor]="interactive ? chordMenu : null"
              (menuOpened)="selectedChord.set(t.chord)"
            >
              {{ t.chord }}
            </button>
          } @else {
            <span class="bm-flow-chord bm-flow-chord--ghost"></span>
          }
          <span class="bm-flow-text">{{ t.text }}</span>
        </span>
      }
    </div>
  }

  @if (mode === 'chart') {
    <div class="bm-chart-desktop" aria-label="Chord chart desktop">
      <div class="bm-chart-line bm-chart-chords" aria-label="Chords">
        @for (p of builtLine.chords; track p.pos + '_' + p.chord) {
          <span
            class="bm-chord-slot"
            [style.paddingLeft.ch]="chPad(p.pos, $index, builtLine.chords)"
          >
            <button
              type="button"
              class="bm-chord-hit"
              [class.is-hovered]="hoveredChord() === p.chord"
              [class.is-selected]="selectedChord() === p.chord"
              (mouseenter)="hoveredChord.set(p.chord)"
              (mouseleave)="hoveredChord.set(hoveredChord() === p.chord ? null : hoveredChord())"
              (focus)="hoveredChord.set(p.chord)"
              (blur)="hoveredChord.set(hoveredChord() === p.chord ? null : hoveredChord())"
              (click)="selectedChord.set(p.chord)"
              [attr.aria-label]="'Chord ' + p.chord"
              [matMenuTriggerFor]="interactive ? chordMenu : null"
              (menuOpened)="selectedChord.set(p.chord)"
            >
              {{ p.chord }}
            </button>
          </span>
        }
      </div>

      <div class="bm-chart-line bm-chart-lyrics">{{ builtLine.lyrics }}</div>
    </div>
  }

  @if (mode === 'auto') {
    <div class="bm-auto">
      <div class="bm-flow" aria-label="Chord flow">
        @for (t of flow(); track $index) {
          <span class="bm-flow-token" [class.has-chord]="!!t.chord">
            @if (t.chord) {
              <button
                type="button"
                class="bm-chord-hit bm-flow-chord"
                [class.is-hovered]="hoveredChord() === t.chord"
                [class.is-selected]="selectedChord() === t.chord"
                (mouseenter)="hoveredChord.set(t.chord)"
                (mouseleave)="hoveredChord.set(hoveredChord() === t.chord ? null : hoveredChord())"
                (focus)="hoveredChord.set(t.chord)"
                (blur)="hoveredChord.set(hoveredChord() === t.chord ? null : hoveredChord())"
                (click)="selectedChord.set(t.chord)"
                [attr.aria-label]="'Chord ' + t.chord"
                [matMenuTriggerFor]="interactive ? chordMenu : null"
                (menuOpened)="selectedChord.set(t.chord)"
              >
                {{ t.chord }}
              </button>
            } @else {
              <span class="bm-flow-chord bm-flow-chord--ghost"></span>
            }
            <span class="bm-flow-text">{{ t.text }}</span>
          </span>
        }
      </div>

      <div class="bm-chart-desktop" aria-label="Chord chart desktop">
        <div class="bm-chart-line bm-chart-chords" aria-label="Chords">
          @for (p of builtLine.chords; track p.pos + '_' + p.chord) {
            <span
              class="bm-chord-slot"
              [style.paddingLeft.ch]="chPad(p.pos, $index, builtLine.chords)"
            >
              <button
                type="button"
                class="bm-chord-hit"
                [class.is-hovered]="hoveredChord() === p.chord"
                [class.is-selected]="selectedChord() === p.chord"
                (mouseenter)="hoveredChord.set(p.chord)"
                (mouseleave)="hoveredChord.set(hoveredChord() === p.chord ? null : hoveredChord())"
                (focus)="hoveredChord.set(p.chord)"
                (blur)="hoveredChord.set(hoveredChord() === p.chord ? null : hoveredChord())"
                (click)="selectedChord.set(p.chord)"
                [attr.aria-label]="'Chord ' + p.chord"
                [matMenuTriggerFor]="interactive ? chordMenu : null"
                (menuOpened)="selectedChord.set(p.chord)"
              >
                {{ p.chord }}
              </button>
            </span>
          }
        </div>

        <div class="bm-chart-line bm-chart-lyrics">{{ builtLine.lyrics }}</div>
      </div>
    </div>
  }
}

<mat-menu #chordMenu="matMenu" class="bm-chord-menu" yPosition="above" overlapTrigger="false">
  <div class="bm-chord-menu-inner" (click)="$event.stopPropagation()">
    @if (chordInfo(); as info) {
      <div class="bm-chord-menu-title">{{ info.raw }}</div>

      @if (info.root || info.quality) {
        <div class="bm-chord-menu-sub small opacity-75">{{ info.root }} Â· {{ info.quality }}</div>
      }

      @if (info.notes.length > 0) {
        <div class="bm-chord-section-title">Notes</div>
        <div class="bm-chord-notes">
          @for (n of info.notes; track n) {
            <span class="bm-note-pill">{{ n }}</span>
          }
        </div>
      }

      <div class="bm-chord-section-title">Guitar</div>

      @let shapes = info.shapes;
      @let total = shapes.length;
      @let idx = chordShapeIndex();

      @if (total === 0) {
        <div class="bm-shape-empty small opacity-75">No guitar shape yet for this chord (MVP).</div>
      } @else {
        @let sh = shapeAt(shapes, idx);

        <div class="bm-shape-head">
          <div class="bm-shape-left">
            <div class="bm-shape-title">{{ sh.name }}</div>
            @if (total > 1) {
              <div class="bm-shape-count">{{ idx + 1 }} / {{ total }}</div>
            }
          </div>
        </div>

        <div class="bm-shape-stage">
          @if (total > 1) {
            <button
              type="button"
              class="bm-shape-arrow bm-shape-arrow--left"
              aria-label="Previous shape"
              (click)="prevShape(total); $event.stopPropagation()"
            >
              <mat-icon>chevron_left</mat-icon>
            </button>
          }

          <div class="bm-shape-diagram">
            <bm-guitar-chord-diagram
              [shape]="sh"
              [ariaLabel]="'Guitar chord ' + info.raw"
            ></bm-guitar-chord-diagram>
          </div>

          @if (total > 1) {
            <button
              type="button"
              class="bm-shape-arrow bm-shape-arrow--right"
              aria-label="Next shape"
              (click)="nextShape(total); $event.stopPropagation()"
            >
              <mat-icon>chevron_right</mat-icon>
            </button>
          }
        </div>
      }
    } @else {
      <div class="small opacity-75">No chord selected</div>
    }
  </div>
</mat-menu>
